<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
    <title>Mayaa : Documentation : 2-5. 設定の記述方法</title>
    <link rel="STYLESHEET" href="./mayaa.css" type="text/css">
</head>
<body>
<div class="header">
<div>Mayaa : JavaServer Templates</div>
</div>

<div class="navi">
<a href="./customtag.html">←JSP カスタムタグを使う</a>
<a href="./index.html">↑index</a>
<a href="./component1.html">HTML 部品を使う (静的)→</a>
</div>

<div class="main">


<h1>2-5. 設定の記述方法</h1>

<p>Mayaa の設定を記述する方法は大きく分けて 2 種類あります。ひとつはこれまでのサンプルコードのように mayaa ファイルを使う方法、もうひとつはテンプレートの HTML ファイルに直接設定を書き込む方法です。また、この 2 種類の方法を混在させることもできます。</p>

<h2>mayaa ファイルを使う</h2>

<p>Mayaa の基本的な利用方法は、テンプレートに対応する mayaa ファイルを用意する方法です。テンプレートを純粋な HTML のままにしたい場合はこの形を使います。</p>

<!-- テンプレート切り替え機能の話は別 -->
<p>mayaa ファイルはテンプレート HTML ファイルの拡張子を <code>.mayaa</code> に変えた XML ファイルです。テンプレートにつきひとつの mayaa ファイルを用意し、動的な処理を設定します。</p>

<div class="figure">図 2-5-1: テンプレートと mayaa ファイルからページを生成する<br><img src="./images/about_mayaa_standard.png" title="図 2-5-1: テンプレートと mayaa ファイルからページを生成する" width="543" height="222"></div>

<p>記述方法は、前提知識として XML 名前空間を知っていると理解しやすくなります。XML 名前空間に関する説明や参考資料はこのページの最後にあります。ここでは Mayaa の機能を表すプレフィクスとして "<code>m:</code>" を使って説明します。</p>

<h3>mayaa ファイルのタグはプロセッサ</h3>
<p>mayaa ファイルにタグとして書く、Mayaa の様々なテンプレート処理機能のことをプロセッサと呼びます。たとえば「<code>write</code> プロセッサ」を使うなら <code>&lt;m:write&gt;</code> タグを書き、「<code>if</code> プロセッサ」を使うなら <code>&lt;m:if&gt;</code> タグを書きます。</p>


<h3>HTML タグにプロセッサを割り当てる</h3>

<p>動的な出力を行うには、基本的には HTML タグに id 属性を付け、mayaa ファイルでその id を指定してプロセッサと対応させます。デフォルトでは id を指定した元のタグとそのボディ (タグで囲まれた範囲) を消し、mayaa ファイルで定義したプロセッサの出力によって置き換えます。プロセッサのタグに <code>replace="false"</code> と属性を付けた場合、元のタグを消さずにボディだけをプロセッサの出力によって置き換えます。</p>
<p>「置き換える」という点に注意してください。たとえば図 2-5-2 のテンプレートには、id 属性を持つタグが 3 つあります。</p>

<div class="figure">図 2-5-2: id でテンプレート上の要素を識別する<br><img src="./images/mayaa_file2.png" title="図 2-5-2: id で HTML ファイル上の要素を識別する" width="472" height="161"></div>

<p>このテンプレートに対し図 2-5-3 の mayaa ファイルを合わせて実行すると、実際に処理されるのは (A)(1) と (B)(2) のみになります。これは (B) が置き換えられた結果、(B) に内包されている (C) が無くなってしまうためです。</p>

<div class="figure">図 2-5-3: テンプレート上の要素にプロセッサを設定する<br><img src="./images/mayaa_file3.png" title="図 2-5-3: テンプレート上の要素にプロセッサを設定する" width="491" height="104"></div>

<pre>
図 2-5-2 のテンプレートを図 2-5-3 の mayaa ファイルと合わせた場合の実行結果
<div class="file">&lt;html&gt;
&lt;body&gt;
    &lt;h1&gt;dynamic title&lt;/h1&gt;

    dynamic contents
&lt;/body&gt;
&lt;/html&gt;</div></pre>

<p>(C) を有効にするには、(B) にボディ処理できるプロセッサを対応させ、ボディを処理したいタイミングで <code>doBody</code> プロセッサを呼び出します。ボディ処理できるプロセッサには、たとえば <code>if</code> があります。どのプロセッサがボディ処理できるかは<a href="./processor_reference.html">プロセッサ リファレンス</a>を参照してください。</p>
<p>(B) のボディ処理を <code>m:doBody</code> の位置で実行しますが、対応する設定ファイルは元の mayaa ファイル全体です。(3) は (2) の外にありますが、(C) は正しく (C)(3) で処理されます。</p>

<div class="figure">図 2-5-4: ボディを処理するよう設定する<br><img src="./images/mayaa_file4.png" title="図 2-5-4: ボディを処理するよう設定する" width="491" height="133"></div>

<pre>
図 2-5-2 のテンプレートを図 2-5-4 の mayaa ファイルと合わせた場合の実行結果
<div class="file">&lt;html&gt;
&lt;body&gt;
    &lt;h1&gt;dynamic title&lt;/h1&gt;

        &lt;h2&gt;dynamic subtitle&lt;/h2&gt;
        &lt;p&gt;dynamic contentBody&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</div></pre>

<p>もし (2) に <code>m:doBody</code> を書かず (3) をそのまま書いてしまった場合、(B)(2) 処理のときに (3) が id と無関係に処理されます。その際に (C) を囲むタグも (B) と一緒に消えてしまうため、実行結果は (3) の出力のみになります。</p>

<div class="figure">図 2-5-6: ボディとして処理されるプロセッサタグはテンプレートと無関係<br><img src="./images/mayaa_file5.png" title="図 2-5-6: ボディとして処理されるプロセッサタグはテンプレートと無関係" width="525" height="119"></div>

<pre>
図 2-5-2 のテンプレートを図 2-5-6 の mayaa ファイルと合わせた場合の実行結果
<div class="file">&lt;html&gt;
&lt;body&gt;
    &lt;h1&gt;dynamic title&lt;/h1&gt;

        dynamic subtitle
        dynamic contentBody
&lt;/body&gt;
&lt;/html&gt;</div></pre>

<p>(3) がそのまま出力されたように、ボディ処理できるプロセッサのタグボディに書かれたものは基本的にそのまま処理されます (プロセッサに依存)。従って、ここに文字列を書けば文字列がそのまま出力されますし、プロセッサを書けば実行されます。HTML タグはプロセッサと対応しませんので、文字列としてそのまま出力されます。</p>

<div class="figure">図 2-5-7: ボディに書いたタグはそのまま処理される<br><img src="./images/mayaa_file6.png" title="図 2-5-7: ボディに書いたタグはそのまま処理される" width="491" height="169"></div>

<pre>
図 2-5-2 のテンプレートを図 2-5-7 の mayaa ファイルと合わせた場合の実行結果
<div class="file">&lt;html&gt;
&lt;body&gt;
    &lt;h1&gt;dynamic title&lt;/h1&gt;

    &lt;table border="1"&gt;&lt;tr&gt;&lt;td&gt;
        &lt;h2&gt;dynamic subtitle&lt;/h2&gt;
        &lt;p&gt;dynamic contentBody&lt;/p&gt;
    &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;</div></pre>


<h3><a name="implicitDoBody">暗黙の <code>m:doBody</code></a></h3>

<p>Mayaa は次の2点を満たす場合、暗黙的に <code>m:doBody</code> が書かれたものとみなします。</p>

<ul>
<li>ボディ処理できるプロセッサであること</li>
<li>ボディに空白、改行、TAB 文字以外を含まないこと (<a href="./processor_reference.html#attribute" title="attribute プロセッサ">例外あり</a>)</li>
</ul>

<p>たとえば <code>if</code> プロセッサを使い、テンプレート上に書かれたタグの表示/非表示を切り替えるだけの場合、次のように書けます。この例では <code>user</code> というオブジェクトに <code>isManager</code> というメソッドがあり、管理者の場合のみ <code>true</code>を返すとします。</p>

<pre>
page.html
<div class="file">&lt;html&gt;
&lt;body&gt;
    &lt;h1&gt;dynamic title&lt;/h1&gt;

    &lt;div id="adminMenu"&gt;
        &lt;a href="add_user.html"&gt;add user&lt;/a&gt;
    &lt;/div&gt;

    &lt;div&gt;
        contents
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</div>
page.mayaa
<div class="file">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;m:mayaa xmlns:m="http://mayaa.seasar.org"&gt;
    &lt;m:if id="adminMenu" test="&#36;{ user.isManager() }" /&gt;
&lt;/m:mayaa&gt;</div></pre>


<h3><a name="mayaaid">バインディングに HTML の id を使いたくない場合</a></h3>

<p>HTML の id 属性は CSS や JavaScript などから利用することもあります。mayaa ファイルとのバインディングに id 属性を使いたくない場合には、<code>m:id</code> として mayaa 名前空間の id を使うことができます。その場合、mayaa ファイルに書いていた Mayaa の名前空間指定 (<code>xmlns:m="http://mayaa.seasar.org"</code>) を、テンプレートの html タグの属性として書く必要があります。</p>
<p><code>m:id</code> 属性と id 属性の両方がある場合、mayaa ファイルとのバインディングには <code>m:id</code> 属性が優先されます。また、<code>m:id</code> 属性は実行時に出力されません。</p>

<pre>
<code>hello.html</code>
<div class="file">&lt;html <strong>xmlns:m="http://mayaa.seasar.org"</strong>&gt;
&lt;body&gt;
    &lt;span <strong>m:id="message"</strong> id="forCss"&gt;dummy message&lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;</div>
<code>hello.mayaa</code>
<div class="file">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;m:mayaa xmlns:m="http://mayaa.seasar.org"&gt;
    &lt;m:write <strong>id="message"</strong> value="<strong>Hello Mayaa!</strong>" replace="false" /&gt;
&lt;/m:mayaa&gt;</div></pre>


<h2>テンプレート上に設定を書く</h2>

<p>Mayaa は、mayaa ファイルではなくテンプレート上に設定を書くこともできます。後述するレイアウト共有機能など一部の機能は mayaa ファイルを使わなければ実現できませんが、簡単な処理の場合などにファイル数が多くなるのを避けることができます。</p>

<h3>HTML タグにプロセッサを割り当てる</h3>

<p>mayaa ファイルを使う場合は、id によるマッピングで HTML タグにプロセッサを割り当てます。テンプレートに直接書く場合は、その代わりとして <code>m:inject</code> 属性を使います。また、mayaa ファイルに書いていた名前空間指定 (<code>xmlns:m="http://mayaa.seasar.org"</code>) を、テンプレートの html タグの属性として書く必要があります。</p>
<p><code>m:inject</code> 属性の値にはマッピングするプロセッサ名 (mayaa ファイルに書く場合のタグ名) を書き、プロセッサの属性は mayaa ファイルと同様に書きます。ただし、プロセッサの属性のプレフィクスを省略することはできません。(名前空間とプレフィクスについてはこのページの最後で説明しています)</p>
<p>例として <code>m:write</code> (hello.html) と <code>c:out</code> (hello_jstl.html) のサンプルを、テンプレート上に設定を書く形で書き換えてみます。特に <code>c:out</code> のサンプルに注意してください。<code>value</code> は <code>c:out</code> の属性であるため、プレフィクスとして <code>c:</code> が付きます。</p>

<pre>
<code>hello.html</code> でテンプレート上に設定を書いた場合
<div class="file">&lt;html <strong>xmlns:m="http://mayaa.seasar.org"</strong>&gt;
&lt;body&gt;
    &lt;span <strong>m:inject="m:write"</strong> <strong>m:value="Hello Mayaa!"</strong>&gt;dummy message&lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;</div>
<code>hello_jstl.html</code> でテンプレート上に設定を書いた場合
<div class="file">&lt;html <strong>xmlns:m="http://mayaa.seasar.org"</strong>
      <strong>xmlns:c="http://java.sun.com/jsp/jstl/core"</strong>&gt;
&lt;body&gt;
    &lt;span <strong>m:inject="c:out"</strong> <strong>c:value="Hello Mayaa!"</strong>&gt;dummy message&lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;</div></pre>


<h2>mayaa ファイルとテンプレート上の設定の両方を使う</h2>

<p>mayaa ファイルを使う方法とテンプレート上に書く方法の 2 種類を説明しましたが、これらの方法を混在させることもできます。</p>


<pre>
<code>hello.html</code> で id 指定とテンプレート上の設定の両方を使う
<div class="file">&lt;html <strong>xmlns:m="http://mayaa.seasar.org"</strong>&gt;
&lt;body&gt;
    &lt;div <strong>id="condition"</strong>&gt;
    &lt;span <strong>m:inject="m:write" m:value="Hello Mayaa!"</strong>&gt;dummy message&lt;/span&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</div>
<code>hello.mayaa</code>
<div class="file">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;m:mayaa xmlns:m="http://mayaa.seasar.org"&gt;
    &lt;m:if <strong>id="condition"</strong> test="&#36;{ 1 == 1 }" /&gt;
&lt;/m:mayaa&gt;</div></pre>

<p>同じタグにテンプレート上の指定、mayaa ファイルでの指定の両方を書いた場合、テンプレート上の指定が優先されます。</p>


<h2>名前空間とプレフィクス</h2>

<p>Mayaa の設定ファイルは XML 形式で、プロセッサをタグとして記述します。Mayaa のエンジン機能と JSP カスタムタグなどの機能名が重複しないよう、XML 名前空間を利用して区別します。ここでは XML 名前空間についての説明を行いません。また、簡単のため厳密ではない表現をすることがあります。XML 名前空間については<a href="#reference">参考文献</a>をご覧ください。</p>

<p>Mayaa の機能で推奨するプレフィクスは次の通りです。</p>
<table>
<thead>
    <tr><th>機能名</th><th>URL</th><th>推奨プレフィクス</th></tr>
</thead>
<tbody>
    <tr><td>Mayaa のエンジン機能</td><td>http://mayaa.seasar.org</td><td>m</td></tr>
</tbody>
</table>

<p>JSP カスタムタグを利用する場合、JSP の taglib ディレクティブで指定するプレフィクスと URI を、XML 名前空間のプレフィクス、URL として指定します。</p>

<p>属性の名前空間が属しているタグと同じ場合はプレフィクスを省略できます。下の例で青色・斜体になっているプレフィクスが省略可能なものです。これまでのサンプルは省略した形で表記していましたが、厳密な記述をするときにはこの例のようになります。</p>

<pre>
<div class="file">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;m:mayaa xmlns:m="http://mayaa.seasar.org"
        xmlns:c="http://java.sun.com/jsp/jstl/core"&gt;
    &lt;m:if <span class="omit">m:</span>id="role" <span class="omit">m:</span>test="&#36;{ user.isManager() }" &gt;
        &lt;m:write <span class="omit">m:</span>value="manager" /&gt;
    &lt;/m:if&gt;

    &lt;c:out m:id="message" <span class="omit">c:</span>value="Hello Mayaa!" /&gt;
&lt;/m:mayaa&gt;</div></pre>


<h3><a name="reference">参考文献</a></h3>

<dl>
<dt>Namespaces in XML</dt>
<dd><cite><a href="http://www.w3.org/TR/REC-xml-names">http://www.w3.org/TR/REC-xml-names</a></cite></dd>

<dt>XML名前空間の簡単な説明</dt>
<dd><cite><a href="http://www.kanzaki.com/docs/sw/names.html">http://www.kanzaki.com/docs/sw/names.html</a></cite></dd>
</dl>



</div>

<div class="navi">
<a href="./customtag.html">←JSP カスタムタグを使う</a>
<a href="./index.html">↑index</a>
<a href="./component1.html">HTML 部品を使う (静的)→</a>
</div>

<div class="footer">
&copy;2004-2005, The Seasar Foundation and the others, all rights reserved.
</div>

</body>
</html>
